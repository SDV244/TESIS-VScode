
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>roi &#8212; Tesis 2023 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for roi</h1><div class="highlight"><pre>
<div class="viewcode-block" id="filter_window"><a class="viewcode-back" href="../roi.html#roi.filter_window">[docs]</a><span></span><span class="k">def</span> <span class="nf">filter_window</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter a dataframe to get windows of time periods.</span>

<span class="sd">    This function filters a dataframe based on start, end and step time values, creating a new dataframe for each</span>
<span class="sd">    time window. The resulting dataframes are grouped by the file name and stored in a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">    df (pandas.DataFrame): Dataframe to be filtered.</span>
<span class="sd">    start (int): Start time value in seconds.</span>
<span class="sd">    end (int): End time value in seconds.</span>
<span class="sd">    step (int): Step value in seconds to create new time windows.</span>

<span class="sd">    Returns:</span>
<span class="sd">    tuple: A tuple containing:</span>
<span class="sd">        df_mlabel (list): A list of dataframes containing only rows with time between start and end values.</span>
<span class="sd">        fname_lists (dict): A dictionary of dataframes grouped by the file name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_mlabel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fname_lists</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="n">df_windowed</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;min_t&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;max_t&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">step</span><span class="p">)]</span>
        <span class="n">df_mlabel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_windowed</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_windowed</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;fname&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fname_lists</span><span class="p">:</span>
                <span class="n">fname_lists</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname_lists</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_mlabel</span><span class="p">,</span> <span class="n">fname_lists</span></div>
    

<div class="viewcode-block" id="filter_label"><a class="viewcode-back" href="../roi.html#roi.filter_label">[docs]</a><span class="k">def</span> <span class="nf">filter_label</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Filter the dataframe row based on specific labels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    row : pd.Series</span>
<span class="sd">        The row of the dataframe that needs to be filtered.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if the label in the row is one of the specific labels (&#39;PHYCUV_M&#39;, &#39;PHYCUV_F&#39;,&#39;BOAALB_M&#39;, &#39;BOAALB_F&#39;, &#39;BOALUN_F&#39;, &#39;BOALUN_M&#39;, &#39;PHYCUV_M&#39;, &#39;PHYCUV_F&#39;), otherwise False.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PHYCUV_M&#39;</span><span class="p">,</span> <span class="s1">&#39;PHYCUV_F&#39;</span><span class="p">,</span><span class="s1">&#39;BOAALB_M&#39;</span><span class="p">,</span> <span class="s1">&#39;BOAALB_F&#39;</span><span class="p">,</span> <span class="s1">&#39;BOALUN_F&#39;</span><span class="p">,</span> <span class="s1">&#39;BOALUN_M&#39;</span><span class="p">,</span> <span class="s1">&#39;PHYCUV_M&#39;</span><span class="p">,</span> <span class="s1">&#39;PHYCUV_F&#39;</span><span class="p">]</span></div>


  
<div class="viewcode-block" id="save_fname_lists"><a class="viewcode-back" href="../roi.html#roi.save_fname_lists">[docs]</a><span class="k">def</span> <span class="nf">save_fname_lists</span><span class="p">(</span><span class="n">fname_lists</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function saves the data in the `fname_lists` dictionary to csv files. </span>

<span class="sd">    Parameters:</span>
<span class="sd">    fname_lists (dict): A dictionary where the key is a string representing the name of an audio file,</span>
<span class="sd">                        and the value is a list of dataframes.</span>
<span class="sd">    save_path (str): The path to the directory where the csv files should be saved.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>

<span class="sd">    Example:</span>
<span class="sd">    save_fname_lists(fname_lists, &quot;data/csv_files&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dfs</span> <span class="ow">in</span> <span class="n">fname_lists</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="p">):</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  </div>
 

<div class="viewcode-block" id="trim_audio_files"><a class="viewcode-back" href="../roi.html#roi.trim_audio_files">[docs]</a><span class="k">def</span> <span class="nf">trim_audio_files</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">dst_dir</span><span class="p">,</span> <span class="n">chunk_length</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trim the audio files in `src_dir` into smaller chunks of `chunk_length` seconds and save them in `dst_dir`.</span>

<span class="sd">    Each audio file in `src_dir` will be divided into chunks of `chunk_length` seconds and saved in a new folder with the same name as the original file in `dst_dir`. Each chunk will have a unique filename consisting of the original filename followed by an underscore and a chunk index.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_dir : str</span>
<span class="sd">        The path to the source directory containing the audio files.</span>
<span class="sd">    dst_dir : str</span>
<span class="sd">        The path to the destination directory where the trimmed audio chunks will be saved.</span>
<span class="sd">    chunk_length : float</span>
<span class="sd">        The length of each audio chunk in seconds.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function assumes that all audio files in `src_dir` are in WAV format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Loop through the audio files in the source directory</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.wav&quot;</span><span class="p">):</span>
            <span class="c1"># Open the audio file</span>
            <span class="k">with</span> <span class="n">wave</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">audio_file</span><span class="p">:</span>
                <span class="c1"># Get the number of frames in the audio file</span>
                <span class="n">num_frames</span> <span class="o">=</span> <span class="n">audio_file</span><span class="o">.</span><span class="n">getnframes</span><span class="p">()</span>
                <span class="c1"># Get the frame rate of the audio file</span>
                <span class="n">frame_rate</span> <span class="o">=</span> <span class="n">audio_file</span><span class="o">.</span><span class="n">getframerate</span><span class="p">()</span>
                <span class="c1"># Calculate the number of chunks in the audio file</span>
                <span class="n">num_chunks</span> <span class="o">=</span> <span class="n">num_frames</span> <span class="o">//</span> <span class="p">(</span><span class="n">frame_rate</span> <span class="o">*</span> <span class="n">chunk_length</span><span class="p">)</span>

                <span class="c1"># Make a folder for each audio file</span>
                <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">file_dir</span><span class="p">)</span>

                <span class="c1"># Loop through the chunks of audio</span>
                <span class="k">for</span> <span class="n">chunk_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chunks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># Create a new audio file for each chunk</span>
                    <span class="n">chunk_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">chunk_index</span><span class="si">}</span><span class="s2">.wav&quot;</span>
                    <span class="n">chunk_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="n">chunk_filename</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">wave</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">chunk_file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">chunk_file</span><span class="p">:</span>
                        <span class="n">chunk_file</span><span class="o">.</span><span class="n">setnchannels</span><span class="p">(</span><span class="n">audio_file</span><span class="o">.</span><span class="n">getnchannels</span><span class="p">())</span>
                        <span class="n">chunk_file</span><span class="o">.</span><span class="n">setsampwidth</span><span class="p">(</span><span class="n">audio_file</span><span class="o">.</span><span class="n">getsampwidth</span><span class="p">())</span>
                        <span class="n">chunk_file</span><span class="o">.</span><span class="n">setframerate</span><span class="p">(</span><span class="n">audio_file</span><span class="o">.</span><span class="n">getframerate</span><span class="p">())</span>
                        <span class="n">chunk_start</span> <span class="o">=</span> <span class="n">chunk_index</span> <span class="o">*</span> <span class="n">chunk_length</span> <span class="o">*</span> <span class="n">frame_rate</span>
                        <span class="n">chunk_end</span> <span class="o">=</span> <span class="n">chunk_start</span> <span class="o">+</span> <span class="n">chunk_length</span> <span class="o">*</span> <span class="n">frame_rate</span>
                        <span class="n">chunk_file</span><span class="o">.</span><span class="n">writeframes</span><span class="p">(</span><span class="n">audio_file</span><span class="o">.</span><span class="n">readframes</span><span class="p">(</span><span class="n">chunk_end</span> <span class="o">-</span> <span class="n">chunk_start</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ALL AUDIOS TRIMMED SUCCESFULLY&quot;</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="load_annotations"><a class="viewcode-back" href="../roi.html#roi.load_annotations">[docs]</a><span class="k">def</span> <span class="nf">load_annotations</span><span class="p">(</span><span class="n">path_annot</span><span class="p">,</span> <span class="n">nombre</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads annotations from .txt files in the given directory and returns a dataframe.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path_annot : str</span>
<span class="sd">        The path to the folder containing the annotation files.</span>
<span class="sd">    nombre : list</span>
<span class="sd">        A list of strings representing the names of the annotation files (without the &#39;.txt&#39; extension).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_mlabel : pd.DataFrame</span>
<span class="sd">        The dataframe containing the loaded annotations.</span>
<span class="sd">    fname_lists : list</span>
<span class="sd">        A list of filenames corresponding to the loaded annotations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nombre</span><span class="p">)):</span>
        <span class="n">flist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path_annot</span> <span class="o">+</span> <span class="n">nombre</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
            <span class="n">df_aux</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">read_audacity_annot</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.wav&#39;</span><span class="p">)</span>
            <span class="n">df_aux</span> <span class="o">=</span> <span class="n">df_aux</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;min_f&#39;</span><span class="p">,</span> <span class="s1">&#39;max_f&#39;</span><span class="p">])</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span><span class="n">df_aux</span><span class="p">],</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_mlabel</span><span class="p">,</span> <span class="n">fname_lists</span> <span class="o">=</span> <span class="n">filter_window</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_mlabel</span><span class="p">,</span> <span class="n">fname_lists</span></div>
    
    
<div class="viewcode-block" id="generate_spectrogram"><a class="viewcode-back" href="../roi.html#roi.generate_spectrogram">[docs]</a><span class="k">def</span> <span class="nf">generate_spectrogram</span><span class="p">(</span><span class="n">audio_file_path</span><span class="p">,</span> <span class="n">output_file_path</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="mi">22050</span><span class="p">,</span> <span class="n">n_fft</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">hop_length</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate spectrogram from audio file and save it as an image.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    audio_file_path : str</span>
<span class="sd">        Path to audio file</span>
<span class="sd">    output_file_path : str</span>
<span class="sd">        Path to save the generated spectrogram</span>
<span class="sd">    sr : int, optional</span>
<span class="sd">        Sampling rate of the audio file, by default 22050</span>
<span class="sd">    n_fft : int, optional</span>
<span class="sd">        Length of the FFT window, by default 2048</span>
<span class="sd">    hop_length : int, optional</span>
<span class="sd">        Number of samples between successive frames, by default 512</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">sr</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">audio_file_path</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">librosa</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">n_fft</span><span class="o">=</span><span class="n">n_fft</span><span class="p">,</span> <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">))</span>
    <span class="n">log_S</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">amplitude_to_db</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">librosa</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">specshow</span><span class="p">(</span><span class="n">log_S</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>




<div class="viewcode-block" id="generate_spectrograms_from_folder"><a class="viewcode-back" href="../roi.html#roi.generate_spectrograms_from_folder">[docs]</a><span class="k">def</span> <span class="nf">generate_spectrograms_from_folder</span><span class="p">(</span><span class="n">input_folder</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates spectrograms from WAV files in a given folder and saves the spectrograms in a specified output folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_folder : str</span>
<span class="sd">        The path to the folder containing the WAV files.</span>
<span class="sd">    output_folder : str</span>
<span class="sd">        The path to the folder where the spectrograms will be saved. If the folder doesn&#39;t exist, it will be created.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">subdir</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">input_folder</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">input_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">input_file_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.wav&#39;</span><span class="p">):</span>
                <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">subdir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">input_folder</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">generate_spectrogram</span><span class="p">(</span><span class="n">input_file_path</span><span class="p">,</span> <span class="n">output_file_path</span><span class="p">)</span>  </div>
                
                
<div class="viewcode-block" id="get_spectrogram_paths"><a class="viewcode-back" href="../roi.html#roi.get_spectrogram_paths">[docs]</a><span class="k">def</span> <span class="nf">get_spectrogram_paths</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the paths of all PNG files in a directory and its subdirectories.</span>

<span class="sd">    :param directory: A string that represents the path to the directory.</span>
<span class="sd">    :type directory: str</span>
<span class="sd">    :return: A list of strings, where each string is the path to a PNG file.</span>
<span class="sd">    :rtype: list of str</span>

<span class="sd">    Example usage::</span>
<span class="sd">    .. code-block:: python</span>

<span class="sd">        spectrogram_paths = get_spectrogram_paths(&#39;/path/to/directory&#39;)</span>
<span class="sd">        for spectrogram_path in spectrogram_paths:</span>
<span class="sd">            # do something with the spectrogram_path</span>
<span class="sd">            print(spectrogram_path)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spectrogram_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">):</span>
                <span class="n">spectrogram_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">spectrogram_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectrogram_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spectrogram_paths</span></div>


<div class="viewcode-block" id="get_labels_from_csv"><a class="viewcode-back" href="../roi.html#roi.get_labels_from_csv">[docs]</a><span class="k">def</span> <span class="nf">get_labels_from_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function reads a csv file and returns a list of labels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    csv_file_path : str</span>
<span class="sd">        The path to the csv file that contains the labels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        A list of strings representing the labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_spectrogram_dataframe"><a class="viewcode-back" href="../roi.html#roi.create_spectrogram_dataframe">[docs]</a><span class="k">def</span> <span class="nf">create_spectrogram_dataframe</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a Pandas DataFrame containing the names and file paths of spectrograms in a directory.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    directory : str</span>
<span class="sd">        The directory containing the spectrogram files.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        A dataframe containing two columns: &#39;NAME&#39;, the basename of the spectrogram file without the &#39;.png&#39; extension, </span>
<span class="sd">        and &#39;Path&#39;, the file path to the spectrogram.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">spectrogram_paths</span> <span class="o">=</span> <span class="n">get_spectrogram_paths</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">spectrogram_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">spectrogram_paths</span><span class="p">]</span>
    <span class="n">spectrogram_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">spectrogram_names</span><span class="p">,</span> <span class="s1">&#39;Path&#39;</span><span class="p">:</span> <span class="n">spectrogram_paths</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">spectrogram_df</span></div>


<div class="viewcode-block" id="create_label_df"><a class="viewcode-back" href="../roi.html#roi.create_label_df">[docs]</a><span class="k">def</span> <span class="nf">create_label_df</span><span class="p">(</span><span class="n">input_folder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a label DataFrame based on csv files in the input folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_folder : str</span>
<span class="sd">        The path to the folder containing the csv files.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    label_df : pandas DataFrame</span>
<span class="sd">        The created label DataFrame containing the labels of the csv files.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">label_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;PHYCUV_M&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;PHYCUV_F&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;BOAALB_M&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;BOAALB_F&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;BOALUN_F&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;BOALUN_M&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;PHYCUV_M&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;PHYCUV_F&#39;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
    <span class="n">label_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">label_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">input_folder</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                <span class="n">csv_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">get_labels_from_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">label_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">label_dict</span><span class="p">}</span>
                <span class="n">label_df</span> <span class="o">=</span> <span class="n">label_df</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span> <span class="o">**</span><span class="n">label_dict</span><span class="p">},</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">label_df</span></div>


<div class="viewcode-block" id="save_merged_df"><a class="viewcode-back" href="../roi.html#roi.save_merged_df">[docs]</a><span class="k">def</span> <span class="nf">save_merged_df</span><span class="p">(</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Saves the dataframes to a csv file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    merged_df : pandas.DataFrame</span>
<span class="sd">        Dataframe to be saved.</span>
<span class="sd">    save_path : str</span>
<span class="sd">        The path to save the csv file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;label_df.csv&quot;</span><span class="p">)</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utility functions for deep learning sound detection module</span>
<span class="sd">&quot;&quot;&quot;</span></div>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1">#%% Functions for build_dataset.py</span>

<div class="viewcode-block" id="roi2windowed2"><a class="viewcode-back" href="../roi.html#roi.roi2windowed2">[docs]</a><span class="k">def</span> <span class="nf">roi2windowed2</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">roi</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split a single region of interest (roi) into multiple regions of fixed size according</span>
<span class="sd">    to a window length. If window length (wl) is longer than the roi, the result is a single</span>
<span class="sd">    roi of length wl and centered in the middle of the roi. If the window length is </span>
<span class="sd">    shorter than the, the roi is splitted into multiple regions. Regions must have at</span>
<span class="sd">    least 50% of overlap with the new window length. There is no overlap between windows.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wl : float</span>
<span class="sd">        Window length of the resulting regions of interest</span>
<span class="sd">    roi : pandas.core.frame.DataFrame</span>
<span class="sd">        Regions of interest with at least five columns, min_t, max_t, min_f, max_f, label.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    roi_fmt : pandas.core.frame.DataFrame</span>
<span class="sd">        Formated regions of interest with fixed size.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">roi_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">max_t</span> <span class="o">-</span> <span class="n">roi</span><span class="o">.</span><span class="n">min_t</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">roi_len</span> <span class="o">&lt;</span> <span class="n">wl</span><span class="p">:</span>
        <span class="c1"># region shorter than window length</span>
        <span class="n">roi_median</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">min_t</span> <span class="o">+</span> <span class="n">roi_len</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">roi</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;min_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roi_median</span> <span class="o">-</span> <span class="n">wl</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">roi</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;max_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roi_median</span> <span class="o">+</span> <span class="n">wl</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">roi_fmt</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># region larger than window length</span>
        <span class="c1"># compute arrays. If more than 50% overlap remains, add a window</span>
        <span class="n">roi_fmt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;min_t&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">min_t</span><span class="p">,</span> <span class="n">roi</span><span class="o">.</span><span class="n">max_t</span><span class="o">-</span><span class="n">wl</span><span class="o">+</span><span class="p">(</span><span class="n">wl</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">wl</span><span class="p">),</span>
                                 <span class="s1">&#39;max_t&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">min_t</span><span class="o">+</span><span class="n">wl</span><span class="p">,</span> <span class="n">roi</span><span class="o">.</span><span class="n">max_t</span><span class="o">+</span><span class="p">(</span><span class="n">wl</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">wl</span><span class="p">),</span>
                                 <span class="c1">#&#39;min_f&#39;: roi.min_f,</span>
                                 <span class="c1">#&#39;max_f&#39;: roi.max_f,</span>
                                 <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">roi</span><span class="o">.</span><span class="n">label</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">roi_fmt</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Tesis</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">SCRIPTS</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Michael & Sebas.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>